<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin E-commerce</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
    h1,h2 { color:#333; }
    input, select, button { margin:5px 0; padding:8px; border-radius:4px; border:1px solid #ccc; }
    button { cursor:pointer; background:#007bff; color:white; border:none; }
    button:hover { background:#0056b3; }
    .product-card { background:white; border-radius:8px; padding:10px; margin:10px 0; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .product-card img { max-width:100px; margin-right:5px; border-radius:4px; }
    .flex { display:flex; align-items:center; flex-wrap:wrap; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
  <h1>⚙️ Admin Panel</h1>

  <!-- Dashboard admin -->
  <div id="admin">
    <h2>Produits existants</h2>
    <div id="products-list"></div>

    <h2>Ajouter / Modifier un produit</h2>
    <input type="text" id="title" placeholder="Titre"><br>
    <input type="text" id="slug" placeholder="Slug"><br>
    <input type="text" id="description" placeholder="Description"><br>
    <input type="number" id="price" placeholder="Prix XOF"><br>

    <select id="category"><option value="">Catégorie</option></select><br>
    <select id="subcategory"><option value="">Sous-catégorie</option></select><br>
    <select id="collection"><option value="">Collection</option></select><br>

    <input type="file" id="image"><br>
    <button id="addProduct">Ajouter</button>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const SUPABASE_URL = "https://zcfyqmwgzrphiaaqwrde.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjZnlxbXdnenJwaGlhYXF3cmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY3MjYsImV4cCI6MjA3NjIwMjcyNn0.hRB156XewgSGH0P2obiFOE-leIwxJ42a5x7AyMmXXEU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let editingProduct = null;
    const originalAddFunction = addProduct;

    // --- Charger catégories / sous-catégories / collections
    async function loadSelectors() {
      const { data: cats } = await supabase.from("categories").select("*");
      const { data: subs } = await supabase.from("subcategories").select("*");
      const { data: cols } = await supabase.from("collections").select("*");

      const catSel = document.getElementById("category");
      catSel.innerHTML = '<option value="">Catégorie</option>';
      cats.forEach(c => catSel.innerHTML += `<option value="${c.id}">${c.name}</option>`);

      const subSel = document.getElementById("subcategory");
      subSel.innerHTML = '<option value="">Sous-catégorie</option>';
      subs.forEach(s => subSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);

      const colSel = document.getElementById("collection");
      colSel.innerHTML = '<option value="">Collection</option>';
      cols.forEach(c => colSel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
    }

    // --- Ajouter ou mettre à jour un produit
    async function addProduct() {
      const title = document.getElementById("title").value;
      const slug = document.getElementById("slug").value;
      const description = document.getElementById("description").value;
      const price = parseInt(document.getElementById("price").value);
      const category_id = document.getElementById("category").value || null;
      const subcategory_id = document.getElementById("subcategory").value || null;
      const collection_id = document.getElementById("collection").value || null;
      const imageFile = document.getElementById("image").files[0];

      if (!title || !slug || !price) { alert("Remplir tous les champs"); return; }

      if (editingProduct) {
        // --- Update produit
        const { error } = await supabase.from("products")
          .update({ title, slug, description, price, category_id, subcategory_id, collection_id })
          .eq("id", editingProduct.id);
        if (error) { alert("Erreur mise à jour : " + error.message); return; }

        // --- Upload image si nouveau
        if (imageFile) {
          const { error: imgErr } = await supabase.storage
            .from("product-images")
            .upload(`${editingProduct.id}_${imageFile.name}`, imageFile, { upsert:true });
          if (imgErr) { alert("Erreur upload image : "+imgErr.message); return; }
          await supabase.from("product_images").insert([{ product_id: editingProduct.id, path:`product-images/${editingProduct.id}_${imageFile.name}` }]);
        }

        alert("Produit mis à jour !");
        editingProduct = null;
        document.getElementById("addProduct").innerText = "Ajouter";
      } else {
        // --- Ajouter produit
        const { data: prod, error } = await supabase.from("products")
          .insert([{ title, slug, description, price, category_id, subcategory_id, collection_id, published:true }])
          .select();
        if (error) { alert("Erreur produit : " + error.message); return; }

        if (imageFile) {
          const { error: imgErr } = await supabase.storage
            .from("product-images")
            .upload(`${prod[0].id}_${imageFile.name}`, imageFile, { upsert:true });
          if (imgErr) { alert("Erreur upload image : "+imgErr.message); return; }
          await supabase.from("product_images").insert([{ product_id: prod[0].id, path:`product-images/${prod[0].id}_${imageFile.name}` }]);
        }

        alert("Produit ajouté !");
      }

      // Réinitialiser formulaire
      document.getElementById("title").value = "";
      document.getElementById("slug").value = "";
      document.getElementById("description").value = "";
      document.getElementById("price").value = "";
      document.getElementById("category").value = "";
      document.getElementById("subcategory").value = "";
      document.getElementById("collection").value = "";
      document.getElementById("image").value = "";

      loadProducts();
    }

    document.getElementById("addProduct").onclick = addProduct;

    // --- Charger produits
    async function loadProducts() {
      const { data: products, error } = await supabase.from("products").select("*").order("id");
      const container = document.getElementById("products-list");
      container.innerHTML = "";
      if (error) { container.innerHTML = "Erreur chargement produits : " + error.message; return; }
      if (!products || products.length === 0) { container.innerHTML = "Aucun produit."; return; }

      products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product-card";

        // Récup images
        const imagesDiv = document.createElement("div");
        imagesDiv.className = "flex";
        supabase.from("product_images").select("*").eq("product_id", p.id).then(({ data: imgs }) => {
          if (imgs) imgs.forEach(img => {
            const imgEl = document.createElement("img");
            imgEl.src = `${SUPABASE_URL}/storage/v1/object/public/${img.path}`;
            imagesDiv.appendChild(imgEl);
          });
        });

        div.innerHTML += `<strong>${p.title}</strong> | ${p.price} XOF`;

        const btnEdit = document.createElement("button");
        btnEdit.innerText = "Modifier";
        btnEdit.style.marginLeft="10px";
        btnEdit.onclick = () => {
          editingProduct = p;
          document.getElementById("title").value = p.title;
          document.getElementById("slug").value = p.slug;
          document.getElementById("description").value = p.description || "";
          document.getElementById("price").value = p.price;
          document.getElementById("category").value = p.category_id || "";
          document.getElementById("subcategory").value = p.subcategory_id || "";
          document.getElementById("collection").value = p.collection_id || "";
          document.getElementById("addProduct").innerText = "Mettre à jour";
        };

        const btnDelete = document.createElement("button");
        btnDelete.innerText = "Supprimer";
        btnDelete.style.background="#dc3545";
        btnDelete.onclick = async () => {
          if (!confirm("Supprimer ce produit ?")) return;
          await supabase.from("products").delete().eq("id", p.id);
          loadProducts();
        };

        div.appendChild(imagesDiv);
        div.appendChild(btnEdit);
        div.appendChild(btnDelete);
        container.appendChild(div);
      });
    }

    loadSelectors();
    loadProducts();
  </script>
</body>
</html>






     
