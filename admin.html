<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - E-commerce</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const SUPABASE_URL = "https://zcfyqmwgzrphiaaqwrde.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjZnlxbXdnenJwaGlhYXF3cmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY3MjYsImV4cCI6MjA3NjIwMjcyNn0.hRB156XewgSGH0P2obiFOE-leIwxJ42a5x7AyMmXXEU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginSection = document.getElementById("login-section");
    const dashboard = document.getElementById("dashboard");

    // V√©rifier session
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      loginSection.classList.remove("hidden");
    } else {
      dashboard.classList.remove("hidden");
      loadProducts();
    }

    // --- Login GitHub ---
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'github',
        options: { redirectTo: window.location.href }
      });
      if (error) alert("Erreur : " + error.message);
    });

    // --- D√©connexion ---
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      location.reload();
    });

    // --- Charger les produits ---
    async function loadProducts() {
      const { data: products, error } = await supabase.from("products").select("*").order("id", { ascending: false });
      const container = document.getElementById("products-container");
      container.innerHTML = "";

      if (error) {
        container.innerHTML = `<p class='text-red-500'>Erreur chargement : ${error.message}</p>`;
        return;
      }

      if (!products || products.length === 0) {
        container.innerHTML = `<p class='text-gray-500'>Aucun produit disponible.</p>`;
        return;
      }

      for (const p of products) {
        const { data: imgs } = await supabase.from("product_images").select("path").eq("product_id", p.id).limit(1);
        const imgUrl = imgs && imgs[0]
          ? `${SUPABASE_URL}/storage/v1/object/public/prodoct-images/${imgs[0].path}`
          : "https://via.placeholder.com/150";

        const card = document.createElement("div");
        card.className = "bg-white rounded-2xl shadow p-4 flex flex-col items-center text-center";
        card.innerHTML = `
          <img src="${imgUrl}" class="w-32 h-32 object-cover rounded-xl mb-2">
          <h3 class="font-semibold text-lg">${p.title}</h3>
          <p class="text-gray-500 text-sm mb-2">${p.description || ""}</p>
          <p class="font-bold text-green-600 mb-3">${p.price} XOF</p>
          <button class="deleteBtn bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600" data-id="${p.id}">Supprimer</button>
        `;
        container.appendChild(card);
      }

      // G√©rer suppression
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if (!confirm("Supprimer ce produit ?")) return;
          await supabase.from("products").delete().eq("id", id);
          loadProducts();
        });
      });
    }

    // --- Ajouter un produit ---
    document.getElementById("addProduct").addEventListener("click", async () => {
      const title = document.getElementById("title").value;
      const slug = document.getElementById("slug").value;
      const description = document.getElementById("description").value;
      const price = parseInt(document.getElementById("price").value);
      const imageFile = document.getElementById("image").files[0];

      if (!title || !slug || !price) { alert("Remplir tous les champs obligatoires"); return; }

      const { data: prod, error } = await supabase.from("products").insert([{ title, slug, description, price, published: true }]).select();
      if (error) { alert("Erreur produit : " + error.message); return; }

      if (imageFile) {
        const { error: imgErr } = await supabase.storage.from("prodoct-images")
          .upload(`${prod[0].id}_${imageFile.name}`, imageFile, { upsert: true });
        if (imgErr) { alert("Erreur image : " + imgErr.message); return; }

        await supabase.from("product_images")
          .insert([{ product_id: prod[0].id, path: `${prod[0].id}_${imageFile.name}` }]);
      }

      alert("‚úÖ Produit ajout√© !");
      loadProducts();
    });
  </script>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Section Login -->
  <div id="login-section" class="hidden flex flex-col items-center justify-center h-screen">
    <h1 class="text-3xl font-bold mb-6">Admin E-commerce</h1>
    <button id="loginBtn" class="bg-gray-900 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
      Se connecter avec GitHub
    </button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-900 text-white min-h-screen p-6 flex flex-col justify-between">
      <div>
        <h2 class="text-2xl font-bold mb-8">üõçÔ∏è Admin</h2>
        <nav class="space-y-4">
          <button class="block w-full text-left text-gray-200 hover:text-white" onclick="document.getElementById('products').scrollIntoView()">Produits</button>
          <button class="block w-full text-left text-gray-200 hover:text-white" onclick="document.getElementById('orders').scrollIntoView()">Commandes</button>
        </nav>
      </div>
      <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
        D√©connexion
      </button>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-10 space-y-10">
      <section id="products">
        <h2 class="text-2xl font-bold mb-4">Produits</h2>
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

        <div class="bg-white rounded-xl shadow p-6 mt-10">
          <h3 class="text-xl font-semibold mb-4">Ajouter un produit</h3>
          <input id="title" placeholder="Titre" class="border p-2 rounded w-full mb-3">
          <input id="slug" placeholder="Slug" class="border p-2 rounded w-full mb-3">
          <input id="description" placeholder="Description" class="border p-2 rounded w-full mb-3">
          <input id="price" type="number" placeholder="Prix XOF" class="border p-2 rounded w-full mb-3">
          <input id="image" type="file" class="border p-2 rounded w-full mb-3">
          <button id="addProduct" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Ajouter</button>
        </div>
      </section>

      <section id="orders">
        <h2 class="text-2xl font-bold mb-4">Commandes</h2>
        <p class="text-gray-500">üì¶ Cette section sera bient√¥t disponible.</p>
      </section>
    </main>
  </div>
</body>
</html>




     
