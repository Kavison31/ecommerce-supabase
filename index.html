

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mon E-commerce Supabase</title>
</head>
<body>
  <h1>üõçÔ∏è Bienvenue sur mon e-commerce</h1>
  <div id="session"></div>
  <div id="cart"></div>
  <div id="products"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const SUPABASE_URL = "https://zcfyqmwgzrphiaaqwrde.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjZnlxbXdnenJwaGlhYXF3cmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY3MjYsImV4cCI6MjA3NjIwMjcyNn0.hRB156XewgSGH0P2obiFOE-leIwxJ42a5x7AyMmXXEU";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === Session visiteur ===
    let sessionId = localStorage.getItem("session_id");
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem("session_id", sessionId);
    }
    document.getElementById("session").innerText = `Session visiteur : ${sessionId}`;

    // === Cr√©er panier si n√©cessaire ===
    async function ensureCart() {
      const { data: existing } = await supabase.from("carts")
        .select("*").eq("session_id", sessionId).limit(1);

      if (existing && existing.length > 0) return existing[0];

      const { data, error } = await supabase.from("carts")
        .insert([{ session_id: sessionId }]).select();
      if (error) console.error("Erreur cr√©ation panier :", error.message);
      return data[0];
    }

    const cart = await ensureCart();

    // === Ajouter un produit au panier ===
    async function addToCart(productId, price) {
      const { error } = await supabase.from("cart_items")
        .insert([{ cart_id: cart.id, product_id: productId, unit_price: price, quantity: 1 }]);
      if (error) alert("‚ùå Erreur ajout au panier : " + error.message);
      else { alert("‚úÖ Produit ajout√© !"); showCart(); }
    }

    // === Afficher le panier ===
    async function showCart() {
      const { data: items } = await supabase.from("cart_items")
        .select(`*, product:product_id(*)`)
        .eq("cart_id", cart.id);

      const cartDiv = document.getElementById("cart");
      if (!items || items.length === 0) { cartDiv.innerHTML = "<h2>Panier vide</h2>"; return; }

      let html = "<h2>üõí Panier</h2><ul>";
      let total = 0;
      items.forEach(i => {
        html += `<li>${i.product.title} - ${i.quantity} x ${i.unit_price} XOF</li>`;
        total += i.quantity * i.unit_price;
      });
      html += `</ul><p><strong>Total : ${total} XOF</strong></p>`;
      cartDiv.innerHTML = html;
    }

    // === Afficher les produits ===
    async function showProducts() {
      const { data: products } = await supabase.from("products")
        .select("*").eq("published", true);

      const container = document.getElementById("products");
      if (!products || products.length === 0) { container.innerHTML = "<p>Aucun produit disponible.</p>"; return; }

      container.innerHTML = `<h2>üß∫ Produits disponibles</h2>`;

      for (const p of products) {
        const div = document.createElement("div");
        div.style = "border:1px solid #ccc; padding:10px; margin:10px; border-radius:8px;";

        // Images
        const imagesDiv = document.createElement("div"); imagesDiv.style = "margin-bottom:8px;";
        div.appendChild(imagesDiv);
        const { data: imgs } = await supabase.from("product_images")
          .select("*").eq("product_id", p.id);
        if (imgs.length > 0) {
          imgs.forEach(img => {
            const imgEl = document.createElement("img");
            imgEl.src = `${SUPABASE_URL}/storage/v1/object/public/${img.path}`;
            imgEl.style = "max-width:150px; margin-right:5px; border-radius:4px;";
            imagesDiv.appendChild(imgEl);
          });
        }

        const title = document.createElement("h3"); title.textContent = p.title; div.appendChild(title);
        const desc = document.createElement("p"); desc.textContent = p.description || ""; div.appendChild(desc);
        const price = document.createElement("p"); price.innerHTML = `<strong>${p.price} ${p.currency}</strong>`; div.appendChild(price);

        const btn = document.createElement("button"); btn.textContent = "Ajouter au panier";
        btn.addEventListener("click", async () => await addToCart(p.id, p.price));
        div.appendChild(btn);

        container.appendChild(div);
      }

      showCart(); // afficher le panier au chargement
    }

    showProducts();
  </script>
</body>
</html>
