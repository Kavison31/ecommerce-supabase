<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mon E-commerce Supabase</title>
</head>
<body>
  <h1>üõçÔ∏è Bienvenue sur mon e-commerce</h1>
  <div id="session"></div>
  <div id="products"></div>

  <script type="module">
    // === 1Ô∏è‚É£ Initialisation Supabase ===
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const SUPABASE_URL = "https://zcfyqmwgzrphiaaqwrde.supabase.co"; // <-- remplace ici
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjZnlxbXdnenJwaGlhYXF3cmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY3MjYsImV4cCI6MjA3NjIwMjcyNn0.hRB156XewgSGH0P2obiFOE-leIwxJ42a5x7AyMmXXEU"; // <-- remplace ici

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === 2Ô∏è‚É£ Gestion de session visiteur (localStorage) ===
    let sessionId = localStorage.getItem("session_id");
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem("session_id", sessionId);
    }
    document.getElementById("session").innerText = `Session visiteur : ${sessionId}`;

    // === 3Ô∏è‚É£ Cr√©er un panier visiteur s‚Äôil n‚Äôexiste pas ===
    async function ensureCart() {
      const { data: existing } = await supabase
        .from("carts")
        .select("*")
        .eq("session_id", sessionId)
        .limit(1);

      if (existing && existing.length > 0) return existing[0];

      const { data, error } = await supabase
        .from("carts")
        .insert([{ session_id: sessionId }])
        .select();

      if (error) {
        console.error("Erreur cr√©ation panier :", error.message);
        return null;
      }
      console.log("‚úÖ Panier cr√©√© :", data);
      return data[0];
    }

    const cart = await ensureCart();

    // === 4Ô∏è‚É£ Afficher les produits disponibles ===
    async function showProducts() {
      const { data: products, error } = await supabase
        .from("products")
        .select("*")
        .eq("published", true);

      const container = document.getElementById("products");

      if (error) {
        container.innerHTML = `<p style="color:red;">‚ùå Erreur produits : ${error.message}</p>`;
        return;
      }

      if (!products || products.length === 0) {
        container.innerHTML = `<p>Aucun produit disponible pour le moment.</p>`;
        return;
      }

      container.innerHTML = `<h2>üß∫ Produits disponibles</h2>`;

      products.forEach((p) => {
        const div = document.createElement("div");
        div.style = "border:1px solid #ccc; padding:10px; margin:10px; border-radius:8px;";
        div.innerHTML = `
          <h3>${p.title}</h3>
          <p>${p.description || ""}</p>
          <p><strong>${p.price} ${p.currency}</strong></p>
          <button>Ajouter au panier</button>
        `;

        // Action bouton
        div.querySelector("button").addEventListener("click", async () => {
          await addToCart(p.id, p.price);
        });

        container.appendChild(div);
      });
    }

    // === 5Ô∏è‚É£ Ajouter un produit au panier ===
    async function addToCart(productId, price) {
      const { error } = await supabase
        .from("cart_items")
        .insert([
          { cart_id: cart.id, product_id: productId, unit_price: price, quantity: 1 },
        ]);

      if (error) {
        alert("‚ùå Erreur ajout au panier : " + error.message);
      } else {
        alert("‚úÖ Produit ajout√© au panier !");
      }
    }

    // === 6Ô∏è‚É£ Lancer l‚Äôaffichage ===
    showProducts();
  </script>
</body>
</html>
