<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mon E-commerce Supabase</title>
</head>
<body>
  <h1>üõçÔ∏è Bienvenue sur mon e-commerce</h1>
  <div id="session"></div>
  <div id="products"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    // === 1Ô∏è‚É£ Configuration Supabase ===
    const SUPABASE_URL = "https://zcfyqmwgzrphiaaqwrde.supabase.co"; // <-- remplace par ton URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjZnlxbXdnenJwaGlhYXF3cmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY3MjYsImV4cCI6MjA3NjIwMjcyNn0.hRB156XewgSGH0P2obiFOE-leIwxJ42a5x7AyMmXXEU"; // <-- remplace par ta cl√© Anon
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === 2Ô∏è‚É£ Gestion session visiteur ===
    let sessionId = localStorage.getItem("session_id");
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem("session_id", sessionId);
    }
    document.getElementById("session").innerText = `Session visiteur : ${sessionId}`;

    // === 3Ô∏è‚É£ Cr√©er un panier visiteur s‚Äôil n‚Äôexiste pas ===
    async function ensureCart() {
      const { data: existing } = await supabase
        .from("carts")
        .select("*")
        .eq("session_id", sessionId)
        .limit(1);

      if (existing && existing.length > 0) return existing[0];

      const { data, error } = await supabase
        .from("carts")
        .insert([{ session_id: sessionId }])
        .select();

      if (error) {
        console.error("Erreur cr√©ation panier :", error.message);
        return null;
      }
      console.log("‚úÖ Panier cr√©√© :", data);
      return data[0];
    }

    const cart = await ensureCart();

    // === 4Ô∏è‚É£ Ajouter un produit au panier ===
    async function addToCart(productId, price) {
      const { error } = await supabase
        .from("cart_items")
        .insert([
          { cart_id: cart.id, product_id: productId, unit_price: price, quantity: 1 },
        ]);

      if (error) {
        alert("‚ùå Erreur ajout au panier : " + error.message);
      } else {
        alert("‚úÖ Produit ajout√© au panier !");
      }
    }

    // === 5Ô∏è‚É£ Afficher les produits publi√©s ===
    async function showProducts() {
      const { data: products, error } = await supabase
        .from("products")
        .select("*")
        .eq("published", true);

      const container = document.getElementById("products");

      if (error) {
        container.innerHTML = `<p style="color:red;">‚ùå Erreur produits : ${error.message}</p>`;
        return;
      }

      if (!products || products.length === 0) {
        container.innerHTML = `<p>Aucun produit disponible pour le moment.</p>`;
        return;
      }

      container.innerHTML = `<h2>üß∫ Produits disponibles</h2>`;

      products.forEach((p) => {
        const div = document.createElement("div");
        div.style = "border:1px solid #ccc; padding:10px; margin:10px; border-radius:8px;";

        // --- Images ---
        const imagesDiv = document.createElement("div");
        imagesDiv.style = "margin-bottom:8px;";
        div.appendChild(imagesDiv);

        supabase
          .from("product_images")
          .select("*")
          .eq("product_id", p.id)
          .then(({ data: imgs, error }) => {
            if (!error && imgs.length > 0) {
              imgs.forEach((img) => {
                const imgEl = document.createElement("img");
                imgEl.src = `${SUPABASE_URL}/storage/v1/object/public/${img.path}`;
                imgEl.style = "max-width:150px; margin-right:5px; border-radius:4px;";
                imagesDiv.appendChild(imgEl);
              });
            }
          });

        // --- Titre ---
        const title = document.createElement("h3");
        title.textContent = p.title;
        div.appendChild(title);

        // --- Description ---
        const desc = document.createElement("p");
        desc.textContent = p.description || "";
        div.appendChild(desc);

        // --- Prix ---
        const price = document.createElement("p");
        price.innerHTML = `<strong>${p.price} ${p.currency}</strong>`;
        div.appendChild(price);

        // --- Bouton ---
        const btn = document.createElement("button");
        btn.textContent = "Ajouter au panier";
        btn.addEventListener("click", async () => {
          await addToCart(p.id, p.price);
        });
        div.appendChild(btn);

        container.appendChild(div);
      });
    }

    showProducts();
  </script>
</body>
</html>

